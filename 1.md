# Cloud Functions 運用・保守ドキュメント

## 目次
1. [概要](#概要)
2. [環境情報](#環境情報)
3. [デプロイ手順](#デプロイ手順)
4. [設定管理](#設定管理)
5. [トラブルシューティング](#トラブルシューティング)
6. [監視とログ](#監視とログ)

---

## 概要

本ドキュメントは、招待システムのCloud Functions（バックエンド）に関する運用・保守情報をまとめたものです。

### 主要機能
- 招待メール送信機能
- 招待トークン検証機能
- ユーザー登録処理
- データ暗号化処理

---

## 環境情報

### プロジェクト情報
- **プロジェクトID**: `flow-it-development`
- **リージョン**: `us-central1` 
- **Node.jsバージョン**: v22以上
- **ランタイム**: Node.js 22

### リポジトリ情報
- **GitHubリポジトリ**: https://github.com/JRS-PM/flow_it_invitation_app.git
- **Functions ディレクトリ**: `functions/`

### ディレクトリ構成
```
functions/
├── index.js                 # エントリーポイント
├── package.json             # 依存関係定義
├── .eslintrc.js            # ESLint設定
├── invitation/              # 招待関連の関数
│   ├── sendInvitation.js   # 招待メール送信
│   ├── validateToken.js    # トークン検証
│   └── registerUser.js     # ユーザー登録
└── helpers/                 # ヘルパー関数
    ├── encryption.js       # 暗号化処理
    └── emailService.js     # メール送信サービス
```

---

## デプロイ手順

### 事前準備

#### 1. Firebase CLIのインストール
```bash
npm install -g firebase-tools
```

#### 2. Firebaseへのログイン
```bash
firebase login
```

#### 3. プロジェクトの選択
```bash
firebase use flow-it-development
```

### デプロイ手順

#### 全体デプロイ
```bash
# プロジェクトルートディレクトリで実行
firebase deploy --only functions
```

#### 特定の関数のみデプロイ
```bash
# 招待メール送信関数のみ
firebase deploy --only functions:sendInvitation

# 複数の関数を指定
firebase deploy --only functions:sendInvitation,functions:validateToken
```

#### 本番環境へのデプロイ（推奨手順）
```bash
# 1. functionsディレクトリへ移動
cd functions

# 2. 依存関係の更新
npm install

# 3. リントチェック
npm run lint

# 4. テスト実行（設定されている場合）
npm test

# 5. プロジェクトルートへ戻る
cd ..

# 6. デプロイ実行
firebase deploy --only functions

# 7. デプロイ結果の確認
firebase functions:log
```

### デプロイ後の確認

#### 1. Functions コンソールで確認
https://console.firebase.google.com/project/flow-it-development/functions

#### 2. ログの確認
```bash
# リアルタイムでログを表示
firebase functions:log --only sendInvitation

# 最新100件のログを表示
firebase functions:log --limit 100
```

---

## 設定管理

### Secret Manager の設定

Google Cloud Secret Manager で管理されているシークレット情報:

#### アクセス方法
https://console.cloud.google.com/security/secret-manager?project=flow-it-development

#### 設定されているシークレット

| シークレット名 | 用途 | 値 |
|--------------|------|-----|
| `GMAIL_EMAIL` | 招待メール送信元アドレス | japan.retail.system@gmail.com |
| `GMAIL_PASSWORD` | Gmailアプリパスワード | fikrksqkbcbbqdai |
| `AES_KEY` | データ暗号化キー | gvoVCATK7OfN2Cv+H3duw/7q7gbPCAEY/K8u9eromG0= |
| `APP_DOMAIN` | アプリケーションドメイン | flow-it-invitation.web.app |

#### シークレットの更新方法

1. **Google Cloud Consoleからの更新**
   - Secret Manager コンソールにアクセス
   - 更新するシークレットを選択
   - 「新しいバージョン」をクリック
   - 新しい値を入力して保存

2. **gcloudコマンドでの更新**
```bash
# シークレットの新しいバージョンを作成
echo -n "新しいパスワード" | gcloud secrets versions add GMAIL_PASSWORD --data-file=-
```

#### 注意事項
- シークレットを更新した後は、Functions を再デプロイする必要があります
- パスワードは必ずGmailのアプリパスワードを使用してください（通常のパスワードは使用不可）
- 暗号化キー（AES_KEY）は32バイトのBase64エンコード文字列である必要があります

### Gmailアプリパスワードの取得

招待メール送信に使用するGmailアプリパスワードの取得手順:

1. **Google アカウント設定へアクセス**
   https://myaccount.google.com/apppasswords

2. **アプリパスワードの生成**
   - 「アプリを選択」で「その他(カスタム名)」を選択
   - 名前に「Flow It Invitation」などと入力
   - 「生成」をクリック
   - 生成された16文字のパスワードをコピー

3. **Secret Manager へ登録**
   - コピーしたパスワードを`GMAIL_PASSWORD`シークレットに登録

#### 使用アカウント情報
- **メールアドレス**: japan.retail.system@gmail.com
- **用途**: 招待メールの送信専用

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. デプロイエラー

**エラー**: `Error: HTTP Error: 403, The caller does not have permission`

**解決方法**:
```bash
# プロジェクトの権限を確認
gcloud projects get-iam-policy flow-it-development

# 必要に応じて権限を付与
gcloud projects add-iam-policy-binding flow-it-development \
  --member="user:あなたのメールアドレス" \
  --role="roles/cloudfunctions.developer"
```

#### 2. メール送信エラー

**エラー**: `Error: Invalid login: 535-5.7.8 Username and Password not accepted`

**解決方法**:
- Gmailアプリパスワードが正しく設定されているか確認
- Secret Manager の`GMAIL_PASSWORD`を確認
- 2段階認証が有効になっているか確認

```bash
# シークレットの値を確認（本番環境では実行しないこと）
gcloud secrets versions access latest --secret="GMAIL_PASSWORD"
```

#### 3. Functions のタイムアウト

**エラー**: `Error: function execution timeout`

**解決方法**:
```bash
# タイムアウト時間を延長（例: 60秒から180秒へ）
firebase deploy --only functions:sendInvitation \
  --set-env-vars FUNCTION_TIMEOUT=180
```

または `firebase.json` で設定:
```json
{
  "functions": {
    "timeoutSeconds": 180,
    "memory": "256MB"
  }
}
```

#### 4. 依存関係のエラー

**解決方法**:
```bash
cd functions
rm -rf node_modules package-lock.json
npm install
cd ..
firebase deploy --only functions
```

---

## 監視とログ

### ログの確認方法

#### 1. Firebase コンソールでの確認
https://console.firebase.google.com/project/flow-it-development/functions/logs

#### 2. コマンドラインでの確認
```bash
# すべてのログを表示
firebase functions:log

# 特定の関数のログのみ表示
firebase functions:log --only sendInvitation

# エラーログのみ表示
firebase functions:log --only sendInvitation | grep ERROR

# 最新50件のログを表示
firebase functions:log --limit 50
```

#### 3. Google Cloud Console での詳細確認
https://console.cloud.google.com/logs/query?project=flow-it-development

**高度なログクエリ例**:
```
resource.type="cloud_function"
resource.labels.function_name="sendInvitation"
severity="ERROR"
```

### パフォーマンス監視

#### Cloud Functions コンソール
https://console.cloud.google.com/functions/list?project=flow-it-development

確認項目:
- 実行回数
- 実行時間（平均・最大）
- メモリ使用量
- エラー率
- アクティブインスタンス数

### アラート設定（推奨）

Google Cloud Monitoring でアラートを設定:

1. **エラー率のアラート**
   - エラー率が5%を超えた場合に通知
   
2. **実行時間のアラート**
   - 平均実行時間が10秒を超えた場合に通知

3. **呼び出し回数のアラート**
   - 1時間あたりの呼び出し回数が1000回を超えた場合に通知

---

## メンテナンス

### 定期メンテナンス項目

#### 月次作業
- [ ] ログの確認とエラー分析
- [ ] パフォーマンス指標の確認
- [ ] 依存関係の脆弱性チェック

```bash
cd functions
npm audit
npm outdated
```

#### 四半期作業
- [ ] 依存関係のアップデート
- [ ] コードレビューとリファクタリング
- [ ] 負荷テストの実施

```bash
cd functions
npm update
npm audit fix
```

### バックアップとロールバック

#### 以前のバージョンへのロールバック
```bash
# デプロイ履歴の確認
gcloud functions list --project=flow-it-development

# 特定のバージョンへロールバック
gcloud functions deploy sendInvitation \
  --source=gs://バケット名/ソースパス \
  --runtime=nodejs22 \
  --project=flow-it-development
```

---

## セキュリティ

### セキュリティチェックリスト

- [ ] Secret Manager のシークレットが適切に保護されている
- [ ] Functions の権限が最小限に設定されている
- [ ] HTTPS通信のみを使用している
- [ ] 入力値の検証が実装されている
- [ ] レート制限が設定されている
- [ ] ログに機密情報が出力されていない

---

### 開発チーム
- **プロジェクト管理**: JRS-PM
- **リポジトリ**: https://github.com/JRS-PM/flow_it_invitation_app

### 関連リンク
- Firebase Console: https://console.firebase.google.com/project/flow-it-development
- Google Cloud Console: https://console.cloud.google.com/?project=flow-it-development
- Secret Manager: https://console.cloud.google.com/security/secret-manager?project=flow-it-development

---

## 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025-11-10 | 1.0 | 初版作成 | ハサン |

---

**注意**: このドキュメントには機密情報が含まれています。適切に管理してください。
