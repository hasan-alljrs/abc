# ユーザーフロー - 招待機能

本ドキュメントでは、招待者（Inviter）と被招待者（Invitee）のユーザーフローを簡潔に説明します。

---

## 目次

1. [概要](#1-概要)
2. [招待者（Inviter）のフロー](#2-招待者inviterのフロー)
3. [被招待者（Invitee）のフロー](#3-被招待者inviteeのフロー)
4. [エラーケース](#4-エラーケース)
5. [画面遷移図](#5-画面遷移図)

---

## 1. 概要

### システム機能
- トークンベースの招待システム
- 有効期限: 7日間
- ロールベースアクセス制御（admin/owner のみ招待可能）
- 自動メール送信

### 登場人物

**招待者（Inviter）**
- 組織の管理者またはオーナー
- 新メンバーを招待する権限を持つ

**被招待者（Invitee）**
- システム未登録の外部ユーザー
- 招待を受けてアカウントを作成

---

## 2. 招待者（Inviter）のフロー

### ステップ 1: 招待送信

**画面: メンバー管理**
```
[新しいメンバーを招待]
  ↓
招待フォーム
├─ メールアドレス: [入力]
├─ ロール: [Member/Admin/Owner]
└─ [招待を送信]
```

### ステップ 2: システム処理

**Cloud Function: `sendInvitation`**

```javascript
// フロントエンド
await sendInvite({
  email: 'invitee@example.com',
  oid: 'org_001',
  role: 'member'
});
```

**処理内容:**
1. 認証・権限チェック
2. 重複チェック（既存ユーザー/招待）
3. トークン生成（32バイト hex）
4. Firestore に招待作成
   - `status: 'pending'`
   - `expiresAt: 現在+7日`
5. 招待URL生成: `https://example.com/accept?token=xxx`
6. Gmail でメール送信

### ステップ 3: 完了

**成功時:**
```javascript
{
  success: true,
  message: "招待メールを送信しました",
  invitationId: "inv_12345"
}
```

**UI表示:**
- 成功メッセージ
- メンバー一覧に「招待中」ステータスで追加

---

## 3. 被招待者（Invitee）のフロー

### ステップ 1: メール受信

**メール内容:**
```
件名: [組織名] への招待

あなたは [招待者名] から [組織名] に招待されました。

以下のリンクをクリックしてアカウントを作成:
https://example.com/accept?token=abc123...

有効期限: 2024年12月31日 23:59
```

### ステップ 2: 招待確認

**URL:** `/accept?token=abc123...`

**Cloud Function: `verifyToken`**

```javascript
// ページロード時に自動実行
const result = await verify({ token });
// => { valid: true, email: 'invitee@example.com', oid: 'org_001' }
```

**処理内容:**
1. トークン検証
2. 招待検索
3. 有効期限チェック
4. ステータス確認（`pending`）

### ステップ 3: アカウント作成

**登録フォーム:**
```
アカウント登録
────────────────
組織: [組織名]
メール: invitee@example.com (固定)

パスワード: [入力]
パスワード確認: [入力]
[アカウントを作成する]
```

### ステップ 4: 登録処理

**処理順序:**

#### 4-1. パスワード暗号化
```javascript
const encrypted = await encrypt({ text: password });
// => { cipher: '...', iv: '...' }
```

#### 4-2. Firebase Auth でユーザー作成
```javascript
await createUserWithEmailAndPassword(auth, email, password);
// => 自動ログイン
```

#### 4-3. 登録完了

**Cloud Function: `completeRegistration`**

```javascript
await complete({
  token: tokenFromURL,
  userPasswordHash: JSON.stringify(encrypted)
});
```

**処理内容:**
1. 認証チェック
2. 招待検証（email一致、有効期限）
3. `master_web_user` にユーザー追加
4. カスタムクレーム設定（`oid`, `role`）
5. 招待ステータス更新（`accepted`）

### ステップ 5: 完了

**成功画面:**
```
登録完了
────────────────
[組織名] への登録が完了しました！

メール: invitee@example.com
ロール: メンバー

[ダッシュボードへ] ← 3秒後に自動遷移
```

---

## 4. エラーケース

### 招待者側のエラー

| エラー | 条件 | メッセージ |
|--------|------|-----------|
| 権限不足 | ロールが `member` | 「招待権限がありません」 |
| 既存ユーザー | メールが登録済み | 「既に登録されています」 |
| 重複招待 | 同じメールに `pending` 招待あり | 「既に招待済みです」 |

### 被招待者側のエラー

| エラー | 条件 | メッセージ |
|--------|------|-----------|
| 無効なトークン | トークンが存在しない | 「招待リンクが無効です」 |
| 期限切れ | `expiresAt` < 現在時刻 | 「有効期限が切れています」 |
| 既に承認済み | `status` が `accepted` | 「この招待は承認済みです」 |
| メール不一致 | 招待email ≠ Auth email | 「メールアドレスが一致しません」 |

---

## 5. 画面遷移図

### 招待者の画面遷移

```
[ダッシュボード]
       ↓
[メンバー管理]
       ↓
[招待フォーム]
       ↓
  ┌─[処理中]─┐
  │           │
成功        失敗
  │           │
  ↓           ↓
[完了]    [エラー]
  │           │
  └─→[メンバー管理]
```

### 被招待者の画面遷移

```
[メール] → [リンククリック]
              ↓
         [招待確認]
              ↓
         ┌─[検証]─┐
         │         │
      有効      無効
         │         │
         ↓         ↓
   [登録フォーム] [エラー画面]
         │           │
         ↓           ↓
    [処理中]    [トップへ]
         │
    ┌────┴────┐
    │          │
  成功       失敗
    │          │
    ↓          ↓
 [完了画面]  [エラー]
    │          │
    ↓          │
[ダッシュボード]←┘
```

---

## 6. シーケンス図

### 招待送信

```
招待者 → フロントエンド → Cloud Functions → Firestore → Gmail
                             ↓
                        権限チェック
                        重複チェック
                        トークン生成
                        招待作成
                        メール送信
                             ↓
                        成功レスポンス
```

### 招待受け取り

```
被招待者 → フロントエンド → Cloud Functions → Firestore → Firebase Auth
                              ↓
                         verifyToken
                              ↓
                         登録フォーム
                              ↓
                         dataEncryption
                              ↓
                         createUser ────────→ Auth
                              ↓
                         completeRegistration
                         ├─ ユーザー追加
                         ├─ クレーム設定 ──→ Auth
                         └─ 招待更新
                              ↓
                         完了
```

---

## 7. データフロー

### 招待レコード（user_invitation）

**作成時:**
```javascript
{
  email: 'invitee@example.com',
  oid: 'org_001',
  token: 'abc123...',
  status: 'pending',
  role: 'member',
  invitedBy: 'inviter_uid',
  createdAt: Timestamp,
  expiresAt: Timestamp + 7日,
  ciphers: [...]
}
```

**承認後:**
```javascript
{
  ...上記,
  status: 'accepted',
  acceptedAt: Timestamp,
  userId: 'user_uid_123'
}
```

### ユーザーレコード（master_web_user）

```javascript
{
  email: 'invitee@example.com',
  oid: 'org_001',
  role: 'member',
  password: '{"cipher":"...","iv":"..."}', // 暗号化済み
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

### カスタムクレーム（Firebase Auth）

```javascript
{
  oid: 'org_001',
  role: 'member'
}
```

---

## 8. API 呼び出し例

### 招待送信

```javascript
import { httpsCallable } from 'firebase/functions';

const sendInvitation = httpsCallable(functions, 'sendInvitation');

try {
  const result = await sendInvitation({
    email: 'invitee@example.com',
    oid: 'org_001',
    role: 'member'
  });
  console.log(result.data);
  // => { success: true, message: "...", invitationId: "..." }
} catch (error) {
  console.error(error.code, error.message);
}
```

### トークン検証

```javascript
const verifyToken = httpsCallable(functions, 'verifyToken');

try {
  const result = await verifyToken({ token });
  console.log(result.data);
  // => { valid: true, email: "...", oid: "..." }
} catch (error) {
  if (error.code === 'deadline-exceeded') {
    // 期限切れ処理
  }
}
```

### 登録完了

```javascript
// 1. パスワード暗号化
const encrypt = httpsCallable(functions, 'dataEncryption');
const encrypted = await encrypt({ text: password });

// 2. Firebase Auth でユーザー作成
await createUserWithEmailAndPassword(auth, email, password);

// 3. 登録完了
const complete = httpsCallable(functions, 'completeRegistration');
await complete({
  token,
  userPasswordHash: JSON.stringify(encrypted.data)
});
```

---

## 9. チェックリスト

### 招待者

- [ ] 管理者またはオーナー権限でログイン
- [ ] 有効なメールアドレスを入力
- [ ] 適切なロールを選択
- [ ] 招待送信を実行
- [ ] 成功メッセージを確認

### 被招待者

- [ ] 招待メールを受信
- [ ] リンクをクリック（有効期限内）
- [ ] 招待情報を確認
- [ ] 強力なパスワードを設定
- [ ] 利用規約に同意
- [ ] アカウント作成を実行
- [ ] 完了画面を確認

---

## 10. トラブルシューティング

### よくある問題

**Q: 招待メールが届かない**
- 迷惑メールフォルダを確認
- メールアドレスの入力ミスを確認
- 管理者に再送信を依頼

**Q: 「期限切れ」エラーが表示される**
- 招待は7日間のみ有効
- 管理者に新しい招待の送信を依頼

**Q: 「既に登録されています」エラー**
- 既にアカウントが存在する可能性
- ログインページからサインインを試行

**Q: パスワードが弱すぎる**
- 8文字以上
- 英字、数字、記号を含む
- 例: `SecurePass123!`

---

## まとめ

### 招待者のフロー（3ステップ）
1. メンバー管理画面で招待フォームを開く
2. メールアドレスとロールを入力して送信
3. 成功メッセージを確認

### 被招待者のフロー（5ステップ）
1. 招待メールのリンクをクリック
2. 招待情報を確認
3. パスワードを設定
4. アカウントを作成
5. ダッシュボードへ移動

### 重要なポイント
- ✅ 招待の有効期限は7日間
- ✅ 招待できるのは admin/owner のみ
- ✅ パスワードは暗号化して保存
- ✅ カスタムクレームで権限管理
