# Cloud Functions - データ & API 設計ドキュメント

本ドキュメントでは、`functions/` フォルダ内の Firebase Cloud Functions（招待機能）について、データ構造・各 API の入出力・エラー設計・認可要件・シークレット管理・実装上の注意点を説明します。

## 対象ファイル

- `functions/index.js`
- `functions/config.js`
- `functions/invitation/send.js`
- `functions/invitation/verify.js`
- `functions/invitation/complete.js`
- `functions/helpers/database.js`
- `functions/helpers/encryption.js`
- `functions/helpers/email.js`

---

## 目次

1. [概要](#1-概要)
2. [シークレット・環境変数](#2-シークレット環境変数)
3. [Firestore データモデル](#3-firestore-データモデル)
4. [Cloud Functions API 仕様](#4-cloud-functions-api-仕様)
5. [認可・エラー仕様](#5-認可エラー仕様)
6. [クライアント実装例](#6-クライアント実装例)
7. [処理フロー](#7-処理フロー)
8. [ローカル開発・テスト](#8-ローカル開発テスト)
9. [セキュリティ推奨事項](#9-セキュリティ推奨事項)

---

## 1. 概要

本プロジェクトは、組織への招待機能を実現するサーバーレス関数群です。以下の機能を提供します。

- **招待トークンの発行とメール送信**
- **招待トークンの検証**
- **招待承認とユーザー登録処理**（組織へのユーザー追加、カスタムクレーム設定）
- **機密データの暗号化・復号化**

すべての関数は Firebase Cloud Functions の `onCall` 形式で実装されています（`functions/index.js` を参照）。

---

## 2. シークレット・環境変数

`functions/config.js` で Secret Manager または環境変数から取得します。

### 必須シークレット

| 変数名 | 説明 |
|--------|------|
| `GMAIL_EMAIL` | 招待メール送信用 Gmail アドレス |
| `GMAIL_PASSWORD` | Gmail パスワード（推奨:App Password） |
| `AES_KEY` | AES-256 暗号化用の鍵（Base64 エンコード済み 32 バイト） |
| `APP_DOMAIN` | フロントエンドドメイン（例: `flow-it.example.com`） |

### 注意事項

- 本番環境では Secret Manager の使用を推奨します
- ローカル開発では `.env` ファイルまたはエミュレータ設定を使用してください
- `AES_KEY` は Base64 形式で保存し、`encryption.js` 内で Buffer に変換して使用します

---

## 3. Firestore データモデル

### `user_invitation` コレクション（招待情報）

**ドキュメント ID**: 自動生成

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `email` | string | 招待対象のメールアドレス |
| `oid` | string | 組織 ID |
| `token` | string | 招待トークン（ランダム hex） |
| `status` | string | `pending` / `accepted` / `expired` |
| `role` | string | 付与するロール（例: `member`） |
| `invitedBy` | string | 招待者の UID |
| `createdAt` | timestamp | 作成日時 |
| `expiresAt` | timestamp | 有効期限（作成日+7日） |
| `ciphers` | array | 暗号化された email/oid の cipher/iv 情報 |
| `acceptedAt` | timestamp | 承認日時（承認時に追加） |
| `userId` | string | 承認したユーザー ID（承認時に追加） |

### `master_web_user` コレクション（ユーザー情報）

**ドキュメント ID**: メールアドレス

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `oid` | string | 組織 ID |
| `email` | string | メールアドレス |
| `role` | string | ユーザーロール |
| `password` | string | 暗号化済みパスワード |
| `createdAt` | timestamp | 作成日時 |
| `updatedAt` | timestamp | 更新日時 |

**注意**: 現在の `firestore.rules` は開発用の緩い設定（`allow read, write: if true`）です。本番環境では厳格なルールへの変更が必須です。

---

## 4. Cloud Functions API 仕様

クライアントは `firebase/functions` の `httpsCallable` を使用して呼び出します。

### 4.1 sendInvitation

**機能**: 管理者・オーナーが外部メールアドレスに招待を送信

**実装**: `functions/invitation/send.js`

**認証要件**: 必須（`request.auth`）。招待送信者のロールを確認し、`member` の場合は拒否

#### リクエスト

```javascript
{
  email: string,      // 招待先メールアドレス（必須）
  oid: string,        // 組織 ID（必須）
  role?: string       // 招待時に指定するロール
}
```

#### レスポンス（成功時）

```javascript
{
  success: true,
  message: string,
}
```

#### エラーコード

| コード | 説明 |
|--------|------|
| `unauthenticated` | 認証情報なし |
| `invalid-argument` | email/oid が不足 |
| `not-found` | 招待者のユーザー情報が見つからない |
| `permission-denied` | 招待者が member で権限不足 |
| `already-exists` | 対象メールが既に登録済み、または pending 招待が存在 |
| `internal` | サーバー内部エラー |

#### 処理フロー

1. 認証確認と招待者のロール検証
2. 既存ユーザー・既存招待の重複チェック
3. 招待トークン生成（`helpers/encryption.generateToken`）
4. 招待レコード作成（有効期限: 現在+7日）
5. 招待 URL 生成（`https://<APP_DOMAIN>/accept?token=<token>`）
6. HTML メール生成と送信

---

### 4.2 verifyToken

**機能**: 招待トークンの有効性を検証

**実装**: `functions/invitation/verify.js`

**認証要件**: 不要

#### リクエスト

```javascript
{
  token: string       // 招待トークン（必須）
}
```

#### レスポンス（成功時）

```javascript
{
  valid: true,
  email: string,
  oid: string
}
```

#### エラーコード

| コード | 説明 |
|--------|------|
| `invalid-argument` | token が未指定 |
| `not-found` | 招待が見つからない |
| `deadline-exceeded` | 招待が期限切れ（自動的に expired に更新） |
| `internal` | サーバー内部エラー |

#### 処理フロー

1. トークン検証
2. `findInvitationByToken` で招待を検索
3. 有効期限チェック（`isInvitationExpired`）
4. 期限切れの場合は `markInvitationExpired` を実行し、`deadline-exceeded` エラーを返す
5. 有効な場合は email/oid を返す

---

### 4.3 completeRegistration

**機能**: 招待承認とユーザー登録完了処理

**実装**: `functions/invitation/complete.js`

**認証要件**: 必須（`request.auth`）。クライアント側で `createUserWithEmailAndPassword` 実行後に呼び出し

#### リクエスト

```javascript
{
  token: string,              // 招待トークン（必須）
  userPasswordHash: string    // 暗号化済みパスワード情報（JSON文字列）
                              // 例: JSON.stringify({ cipher, iv })
}
```

#### レスポンス（成功時）

```javascript
{
  success: true,
  message: "登録が完了しました",
  oid: string,
  ...
}
```

#### エラーコード

| コード | 説明 |
|--------|------|
| `unauthenticated` | 認証情報なし |
| `invalid-argument` | token が未指定 |
| `not-found` | 招待が見つからない |
| `permission-denied` | 招待の email と認証ユーザーの email が不一致 |
| `deadline-exceeded` | 招待の期限切れ |
| `internal` | サーバー内部エラー |

#### 処理フロー

1. 認証確認
2. `findInvitationByToken` で招待を検索
3. 招待 email と認証ユーザー email の一致確認
4. 有効期限チェック
5. `addUserToOrganization` でユーザーを組織に追加（password フィールドに `userPasswordHash` を保存）
6. `admin.auth().setCustomUserClaims` でカスタムクレーム設定（`oid`, `role`）
7. `markInvitationAccepted` で招待ステータスを `accepted` に更新

**重要**: パスワードはフロントエンドで `dataEncryption` を使って暗号化してから送信します。Cloud Functions 側では復号せずそのまま保存する設計ですが、セキュリティ上の改善が推奨されます（詳細は [セキュリティ推奨事項](#9-セキュリティ推奨事項) を参照）。

---

### 4.4 dataEncryption / dataDecryption

**機能**: クライアントが機密データを AES-256-CBC で暗号化・復号化

**実装**: `functions/helpers/encryption.js` および `functions/index.js`

#### dataEncryption

**リクエスト**:
```javascript
{
  text: string
}
```

**レスポンス**:
```javascript
{
  cipher: string,     // Base64 エンコード済み
  iv: string          // Base64 エンコード済み
}
```

#### dataDecryption

**リクエスト**:
```javascript
{
  cipher: string,     // Base64 エンコード済み
  iv: string          // Base64 エンコード済み
}
```

**レスポンス**: 復号された文字列

**注意事項**:
- `AES_KEY` は `config.js` から取得されます
- クライアントは `dataEncryption` で得た `{cipher, iv}` を `JSON.stringify` して `completeRegistration` に渡します

---

## 5. 認可・エラー仕様

### HttpsError コード一覧

| コード | 用途 |
|--------|------|
| `invalid-argument` | 入力パラメータが不正 |
| `not-found` | リソースが存在しない |
| `deadline-exceeded` | 有効期限切れ |
| `unauthenticated` | 認証が必要 |
| `permission-denied` | 権限不足 |
| `already-exists` | リソースが既に存在 |
| `internal` | サーバー内部エラー |

クライアント側では `error.code` と `error.message` を使用して適切にハンドリングしてください。

---

## 6. クライアント実装例

フロントエンド実装は `src/pages/AcceptInvitation.jsx` を参照してください。

### トークン検証

```javascript
import { httpsCallable } from 'firebase/functions';
import { functions } from './services/firebase';

const verify = httpsCallable(functions, 'verifyToken');
const res = await verify({ token });
// 成功: res.data => { valid: true, email, oid }
```

### パスワード暗号化

```javascript
const encrypt = httpsCallable(functions, 'dataEncryption');
const encRes = await encrypt({ text: password });
// encRes.data => { cipher, iv }
```

### 登録完了

```javascript
const complete = httpsCallable(functions, 'completeRegistration');
await complete({ 
  token, 
  userPasswordHash: JSON.stringify(encRes.data) 
});
```

**注意**: `onCall` 関数は Firebase SDK が自動的に認証情報を付与します。ブラウザから呼び出す場合は、`firebase/auth` でログイン済みである必要があります。

---

## 7. 処理フロー

### 招待送信フロー（管理者側）

1. 管理者がクライアントから `sendInvitation({ email, oid, role })` を呼び出し
2. Cloud Functions で以下を実行:
   - 権限チェック
   - トークン生成
   - Firestore に招待レコード作成
   - Gmail で招待メール送信

### 招待受け取りフロー（受信者側）

1. 受信者がメール内の URL（`/accept?token=...`）にアクセス
2. フロントエンドが `verifyToken({ token })` を呼び出し、有効な場合は登録フォームを表示
3. 受信者がパスワードを入力
4. フロントエンドが `dataEncryption` でパスワードを暗号化
5. フロントエンドで `createUserWithEmailAndPassword` を実行してユーザー作成
6. サインイン状態で `completeRegistration({ token, userPasswordHash })` を呼び出し
7. Cloud Functions で以下を実行:
   - 招待検証
   - 組織にユーザー追加
   - カスタムクレーム設定
   - 招待ステータス更新

---

## 8. ローカル開発・テスト

### エミュレータの起動

```bash
firebase emulators:start
```

これにより Auth/Functions/Firestore/Hosting のエミュレータが起動します（`firebase.json` を参照）。

### Functions のローカル実行

```bash
cd functions
npm run serve
```

**推奨**: エミュレータを使用した統合テストを実施してください。

### 環境変数の設定

Secret Manager がローカル環境で利用できない場合は、以下の環境変数を設定してください:

- `GMAIL_EMAIL`
- `GMAIL_PASSWORD`
- `AES_KEY`
- `APP_DOMAIN`

---

## 9. セキュリティ推奨事項

### 1. Firestore ルールの強化

現在の `firestore.rules` は開発用の緩い設定（`allow read, write: if true`）です。本番環境では以下のような厳格なルールに変更してください:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /user_invitation/{invitationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null 
                   && request.auth.token.role in ['admin', 'owner'];
    }
    
    match /master_web_user/{email} {
      allow read: if request.auth != null 
                  && (request.auth.token.email == email 
                      || request.auth.token.role in ['admin', 'owner']);
      allow write: if request.auth != null 
                   && request.auth.token.role in ['admin', 'owner'];
    }
  }
}
```

### 2. パスワード処理の改善

現在の実装ではクライアント側で AES 暗号化したパスワードをそのまま Firestore に保存していますが、以下の改善を推奨します:

**推奨方法**:
- サーバー側で bcrypt などの安全なハッシュアルゴリズムを使用
- または Firebase Authentication のパスワード機能を活用し、Auth の UID をマスターユーザーに紐付ける

### 3. シークレット管理の強化

- `GMAIL_PASSWORD` を直接使用せず、SendGrid などのメール配信サービスの利用を検討
- Secret Manager を本番環境で厳密に運用

### 4. 招待トークンの管理

- 現在の実装では、トークンは一度承認されると `accepted` に更新されるため、再利用は防止されています
- 複数回使用を許可する場合は、追加のセキュリティ対策が必要です

### 5. ログ出力の注意

エラーログに機密情報（メールアドレス、パスワードの断片など）が含まれないよう注意してください。

---

## 付録: リクエスト・レスポンス例

### verifyToken 成功例

**リクエスト**:
```javascript
{ token: "abc123..." }
```

**レスポンス**:
```javascript
{ 
  valid: true, 
  email: "invitee@example.com", 
  oid: "org_001" 
}
```

### sendInvitation 成功例

**リクエスト**（認証必須）:
```javascript
{ 
  email: "invitee@example.com", 
  oid: "org_001", 
  role: "member" 
}
```

**レスポンス**:
```javascript
{ 
  success: true, 
  message: "招待メールを送信しました", 
  invitationId: "<docId>" 
}
```

### completeRegistration 成功例

**リクエスト**（認証必須）:
```javascript
{ 
  token: "...", 
  userPasswordHash: JSON.stringify({ 
    cipher: "...", 
    iv: "..." 
  }) 
}
```

**レスポンス**:
```javascript
{ 
  success: true, 
  message: "登録が完了しました", 
  data: { 
    oid: "org_001", 
    role: "member" 
  } 
}
```

---

## まとめ

本ドキュメントは `functions/` ディレクトリの現在の実装を基に作成されています。今後の改善として、以下を推奨します:

- ✅ Firestore セキュリティルールの厳格化
- ✅ パスワード処理の再設計（サーバー側ハッシュ化または Firebase Auth との統合）
- ✅ E2E テストとセキュリティ監査の実施
- ✅ メール送信サービスの改善（Gmail から専用サービスへの移行）

---
## 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025-12-10 | 1.0 | 初版作成 | ハサン |
---
